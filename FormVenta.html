<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#244a3e; --ink-2:#3c6b5d; --muted:#7ea094; --bg:#f6fbf9; --card:#ffffff;
      --ring:#dfe9e5; --ring-strong:#cfe3dc; --pill:#edf7f2; --accent:#3cb579; --accent-2:#1e8f5c;
      --danger:#e74c3c; --danger-bg:#fbe9e8; --shadow:0 10px 30px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:radial-gradient(1100px 700px at 8% -10%,rgba(60,181,121,.10),transparent 40%), var(--bg);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);}
    
    .shell{max-width:1080px; margin:26px auto 60px; padding:0 18px}
    
    /* --- TARJETAS MODULARES --- */
    .section-card {
      background: #fff;
      border: 1px solid var(--ring);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 28px 32px;
      margin-bottom: 24px;
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--ink);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 0 20px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--ring);
      display: flex; align-items: center; justify-content: space-between;
    }

    /* Header sin fondo blanco para que flote */
    .header-block { text-align: center; margin-bottom: 30px; }
    h1{margin:6px 0 6px; font-weight:800; letter-spacing:.2px; font-size:36px; color:var(--ink);}
    .sub{color:var(--muted); font-weight:600; margin:0;}

    .row-head{display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap; width: 100%;}
    
    .num-wrap{display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; margin-top: 16px;}
    .num-pill{background:var(--pill); border:1px solid var(--ring-strong); border-radius:14px; padding:8px 12px; display:flex; gap:10px; align-items:center; min-width:200px;}
    .num-pill input{width:100%; border:0; outline:0; background:transparent; font-size:18px; font-weight: 700; color: var(--accent-2); text-align: center;}
    .num-pill input::placeholder{color:#b7c9c3}
    
    .chip-del{border:none; background:var(--danger-bg); color:#d64536; font-weight:700; border-radius:8px; padding:6px 10px; cursor:pointer; font-size: 0.8rem;}
    .chip-del:hover{background:#fecaca;}

    .btn-add{border:2px dashed var(--accent); background:rgba(60,181,121,0.05); color: var(--accent-2); border-radius:12px; padding:8px 16px; font-weight:700; cursor:pointer; transition: all .2s;}
    .btn-add:hover{background:rgba(60,181,121,0.1);}

    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:24px}
    @media (max-width:860px){ .grid-2{grid-template-columns:1fr} }
    
    label{display:block; font-weight:700; color:var(--ink-2); margin:0 0 8px; font-size: 0.9rem;}
    
    .field{display:flex; align-items:center; gap:10px; background:#fcfdfd; border:1px solid var(--ring); border-radius:12px; padding:12px 14px; transition: border-color .2s;}
    .field:focus-within{border-color: var(--accent); box-shadow: 0 0 0 3px rgba(60,181,121,0.1);}
    
    .pill{flex:1; border:0; outline:0; font-size:16px; background:transparent; color: var(--ink); width: 100%;}
    .pill::placeholder{color:#b7c9c3}
    
    select.pill{cursor: pointer;}

    .grid-2t{display:grid; grid-template-columns:1fr 1fr; gap:30px}
    @media (max-width:980px){ .grid-2t{grid-template-columns:1fr} }
    
    .time-box{display:flex; align-items:center; gap:12px}
    .time-field{flex:1; display:flex; align-items:center; gap:8px; background:#fcfdfd; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; min-width:200px;}
    .time-field .ico{opacity:.5}
    .time-field input[type="number"]{width:100%; text-align:center; border:0; outline:0; font-size:18px; background:transparent; font-weight:700; color:var(--ink); -moz-appearance:textfield;}
    .time-field input[type=number]::-webkit-outer-spin-button, .time-field input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    .time-field .colon{font-weight:800; color:#5a7a70}
    .ampm{border:1px solid var(--ring-strong); background:var(--pill); color:#2f5a4f; font-weight:800; border-radius:8px; padding:6px 10px; cursor:pointer; min-width:50px; text-align:center;}
    
    .ocr-drop{border:2px dashed #cfe3dc; background:#fbfdfc; border-radius:16px; padding:24px; text-align:center; font-weight:700; color:var(--ink-2); transition: all .2s;}
    .ocr-drop:hover{border-color: var(--accent);}
    .ocr-drop.drag{background:#f2faf5; border-color:#b9dbd0}
    .ocr-note{margin-top:8px; color:#799e93; font-weight:600; font-size:.9rem}
    
    .cta{display:block; width:100%; border:none; border-radius:12px; padding:14px; font-weight:700; font-size:1rem; background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#fff; box-shadow:0 10px 20px rgba(60,181,121,.25); cursor:pointer; text-align:center; margin-top: 16px;}
    .cta[disabled]{opacity:.65; cursor:not-allowed}
    .cta:active{transform: scale(0.98);}
    
    /* Bot√≥n peligroso estilo p√≠ldora (Igual que en Central) */
    .cta-danger{ 
      background: linear-gradient(135deg, #ff7675, #d63031);
      color: #fff; border: none; border-radius: 50px; padding: 10px 24px; 
      font-weight: 700; font-size: 0.9rem; cursor: pointer; 
      box-shadow: 0 4px 12px rgba(214, 48, 49, 0.3); 
      text-transform: uppercase; letter-spacing: 0.5px;
      width: 100%; max-width: 300px; margin: 16px auto 0; display: block;
    }

    .hint{margin-top:12px; text-align:center; font-weight:600; color:#3c6b5d; white-space: pre-wrap; font-size: 0.95rem;}
    .hint.err{color:#c0392b; background: #f9eaea; padding: 8px; border-radius: 8px;}
    
    .list{display:grid; gap:12px; margin-top:16px}
    .card-sm{border:1px solid var(--ring-strong); background:#fff; border-radius:16px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.03);}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    
    /* --- ESTILOS DEL MODAL (NUEVO) --- */
    #modalResult {
        position: fixed; inset: 0; background: rgba(36, 74, 62, 0.4); backdrop-filter: blur(3px);
        z-index: 12000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
    }
    #modalResult.show { display: flex; opacity: 1; }
    .modal-card {
        background: #fff; width: 90%; max-width: 500px; border-radius: 26px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15); padding: 40px; text-align: center;
        transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #modalResult.show .modal-card { transform: scale(1); }

    .toast-center{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; pointer-events:none;}
    .toast-center.show{display:flex; animation:fadeIn .15s ease}
    .toast-center::before{content:""; position:absolute; inset:0; background:rgba(36,74,62,.12); backdrop-filter:blur(2px)}
    .toast-card{position:relative; pointer-events:auto; display:flex; flex-direction:column; align-items:center; gap:.6rem; background:#fff; border:2px solid var(--ring-strong); border-radius:18px; padding:1rem 1.2rem; font-weight:800; color:#3c6b5d; box-shadow:var(--shadow); max-width:min(88vw,600px); text-align:center;}
    .toast-card.error{border-color:#fecaca; color:#b91c1c}

    /* LOGIN OVERLAY */
    #loginOverlay { position: fixed; inset: 0; background: #f6fbf9; z-index: 10000; display: flex; align-items: center; justify-content: center; }
    .login-card { background: #fff; padding: 40px; border-radius: 26px; box-shadow: var(--shadow); border: 1px solid var(--ring); width: 90%; max-width: 400px; text-align: center; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; max-width: 1080px; margin: 20px auto 0; padding: 0 18px; }
    .user-badge { font-weight:700; color:var(--accent-2); background:var(--pill); padding:5px 12px; border-radius:20px; font-size:0.9rem; border: 1px solid var(--ring);}
    .btn-logout { background:none; border:none; color:#7ea094; font-weight:600; cursor:pointer; font-size:0.85rem; text-decoration:underline;}

    @keyframes fadeIn{from{opacity:0} to{opacity:1}}

    /* =========================================
       DISE√ëO M√ìVIL "APP NATIVA" (VERSI√ìN FINAL)
       ========================================= */
    @media only screen and (max-width: 768px) {
      
      /* 1. Forzar modelo de caja global */
      html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
        box-sizing: border-box;
      }

      /* 2. Contenedor Principal Ajustado */
      body {
        padding: 0 !important;
        margin: 0 !important;
        overflow-x: hidden !important; /* Cortar desbordes */
        width: 100vw;
      }

      .shell {
        width: 94vw !important; /* Usar el 94% del ancho de la pantalla */
        max-width: 100% !important;
        margin: 10px auto 40px auto !important;
        padding: 0 !important;
      }

      /* 3. Tarjetas flexibles */
      .section-card {
        padding: 15px !important;
        width: 100% !important;
        border-radius: 12px !important;
        margin-bottom: 15px !important;
      }

      /* 4. Inputs y campos QUE NO SE SALGAN */
      .field, .pill, input, select, .time-field {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important; /* Truco vital para Flexbox */
        font-size: 16px !important; /* Evita zoom al escribir en iPhone */
      }

      /* 5. Estructuras en columna */
      .grid-2, .grid-2t, .row-head, .time-box {
        display: flex !important;
        flex-direction: column !important;
        gap: 10px !important;
      }

      /* 6. El bloque de Referencia + Bot√≥n */
      /* Hacemos que si no caben, el bot√≥n baje */
      div[style*="display:flex; gap:10px; width: 100%;"] {
        flex-wrap: wrap !important;
      }
      #btnForzarPendiente {
        width: 100% !important; /* Bot√≥n ancho completo en m√≥vil */
        margin-top: 5px !important;
        justify-content: center;
      }

      /* 7. Botones CTA */
      .cta, .btn-add {
        width: 100% !important;
        padding: 14px !important;
      }
      
      /* 8. T√≠tulos */
      h1 { font-size: 22px !important; margin-top: 10px !important; }
      .section-title { font-size: 1rem !important; }
      
      /* 9. Header flotante m√°s peque√±o */
      .header-block { margin-bottom: 20px !important; }
    }
  </style>
</head>

<body>

  <div id="modalResult">
    <div class="modal-card">
        <span id="mIcon" class="modal-icon" style="font-size: 4rem; display: block; margin-bottom: 16px;">üéâ</span>
        <div id="mTitle" class="modal-title" style="font-size: 1.5rem; font-weight: 800; color: var(--ink); margin-bottom: 12px;">¬°Venta Exitosa!</div>
        <div id="mMsg" class="modal-msg" style="font-size: 1rem; color: #5a7a70; line-height: 1.5; margin-bottom: 24px; white-space: pre-wrap;">Los n√∫meros se registraron correctamente.</div>
        <button id="mBtn" class="cta" style="width: auto; margin: 0 auto; padding: 10px 32px; border-radius: 50px;">Aceptar</button>
    </div>
  </div>

  <div id="loginOverlay">
    <div class="login-card">
      <h1>Iniciar Sesi√≥n</h1>
      <p class="sub">Ingresa tu clave de asesor</p>
      <div class="field" style="margin-bottom:20px;">
        <input id="loginPwd" type="password" class="pill" placeholder="Contrase√±a..." style="text-align:center">
      </div>
      <button id="btnLogin" class="cta" style="width:100%">Ingresar</button>
      <div id="loginMsg" class="hint"></div>
    </div>
  </div>

  <div class="top-bar" id="topBarShell" style="display:none;">
    <span id="asesorDisplay" class="user-badge">Hola, Asesor</span>
    <button id="btnLogout" class="btn-logout">Salir</button>
  </div>

  <div class="shell" id="appShell" style="display:none">
    
    <div class="header-block">
      <h1 style="color:#2d5b4f; text-transform:uppercase;">REGISTRAR VENTA</h1>
      <p class="sub">APARMENT
      </p>
    </div>

    <div class="section-card">
      <div class="section-title">
        <span>üéüÔ∏è N√∫meros de Boleta</span>
        <button id="btnAddNum" class="btn-add">+ Agregar</button>
      </div>
      <div id="numList" class="num-wrap"></div>
    </div>

    <div class="section-card">
      <div class="section-title">üë§ Datos del Cliente</div>
      
      <div style="margin-bottom: 20px; background: #e6fffa; border: 2px dashed var(--accent); border-radius: 12px; padding: 16px;">
        <label for="magicPaste" style="color: var(--ink-2); margin-bottom: 8px; font-size: 0.9rem; display:block;">
          ‚ú® <b>Pegado R√°pido:</b> Copia el bloque de texto del cliente y p√©galo aqu√≠.
        </label>
        <textarea id="magicPaste" rows="5" class="pill" 
          placeholder="Ejemplo:
Mateo
Plata Buitrago
Chinchin√°, Caldas
2992
+57312...
f1599..." 
          style="width:100%; resize:none; border:1px solid #cfe3dc; background:#fff; padding:10px; font-size:0.85rem; font-family:monospace; color:#333;"></textarea>
      </div>
      <div class="grid-2">
        <div><label for="v_nombre">Nombre</label><div class="field"><input id="v_nombre" class="pill" type="text" placeholder="Nombre" required></div></div>
        <div><label for="v_apellido">Apellido</label><div class="field"><input id="v_apellido" class="pill" type="text" placeholder="Apellidos" required></div></div>
        <div><label for="v_ciudad">Ciudad</label><div class="field"><input id="v_ciudad" class="pill" type="text" placeholder="Ciudad" required></div></div>
        <div><label for="v_telefono">Tel√©fono</label><div class="field"><input id="v_telefono" class="pill" type="tel" placeholder="+57..." required></div></div>
        
        <div style="grid-column: 1 / -1;">
           <label for="v_ns_usuario">NS de Usuario (Chatea Pro)</label>
           <div class="field" style="background: #fff;">
            <span style="font-size:1.2rem; opacity:0.7;">üÜî</span>
            <input id="v_ns_usuario" class="pill" type="text" placeholder="Escribe el NS aqu√≠..." required style="color:#244a3e; font-family:monospace; font-weight:700;">
            </div>
        </div>
        </div>
    </div>

    <div class="section-card">
      <div class="section-title">üîç Buscar Pago (Transferencia)</div>
      <div class="grid-2t" style="align-items:start">
        
        <div style="display:flex; flex-direction:column; gap:16px;">
          <label style="margin-bottom:0">Por Fecha y Hora</label>
          <div class="time-box">
            <div style="flex:1; min-width:160px">
              <div class="field"><input id="t_fecha" class="pill" type="date"></div>
            </div>
            <div style="flex:1; min-width:180px">
              <div class="time-field">
                <span class="ico">‚è±Ô∏è</span>
                <input id="t_hh" type="number" min="1" max="12" placeholder="hh">
                <span class="colon">:</span>
                <input id="t_mm" type="number" min="0" max="59" placeholder="mm">
                <button id="t_ampm" type="button" class="ampm">AM</button>
              </div>
            </div>
          </div>
          <button id="btnBuscarFecha" class="cta" style="margin:0;">Buscar por Fecha</button>
        </div>

        <div style="display:flex; flex-direction:column; gap:16px;">
          <label style="margin-bottom:0">Por Comprobante (OCR)</label>
          <div id="ocrDrop" class="ocr-drop" tabindex="0" aria-label="Pega tu screenshot aqu√≠">
            <div id="ocrStatus" class="ocr-note">pega aqu√≠ tu screenshot</div>
          </div>
          <div style="margin-top: 10px;">
   <button id="btnBuscarRef" class="cta" style="width:100%; margin:0;">Buscar Ref</button>
          </div>
        </div>
      </div>

      <div id="feedbackTransfer" class="hint" style="margin-top:16px;"></div>
      <div id="listaTransfer" class="list"></div>
      <button id="btnCambiarTransfer" class="cta-danger" style="display:none;">Cambiar transferencia</button>
    </div>

    <div class="section-card">
      <div class="section-title">üí∞ Detalle del Pago</div>
      <div class="grid-2">
        <div><label for="v_primerAbono">Valor a Abonar (Total)</label><div class="field"><input id="v_primerAbono" class="pill" type="number" min="0" value="0" placeholder="$ 0" required></div></div>
        <div>
          <label for="v_metodoPago">M√©todo de pago</label>
          <div class="field">
            <select id="v_metodoPago" class="pill" required>
              <option value="">Selecciona...</option>
              <option value="Nequi">Nequi</option>
              <option value="Daviplata">Daviplata</option>
              <option value="Bancolombia">Bancolombia</option>
              <option value="Efectivo">Efectivo</option>
              <option value="Separado">Separado</option>
              <option value="No encontrado">No encontrado</option>
            </select>
          </div>
        </div>
        <div>
          <label for="v_referenciaAbono">Referencia de la transferencia</label>
          <div style="display:flex; gap:10px; width: 100%;">
            
            <div class="field" style="flex:1; min-width: 0;">
              <input id="v_referenciaAbono" class="pill" type="text" placeholder="Ej: M123456" required>
            </div>

            <button id="btnForzarPendiente" type="button" class="cta" style="margin:0; background:linear-gradient(135deg, #e67e22, #d35400); padding: 0 20px; font-size:0.9rem; white-space:nowrap; box-shadow:none; height:auto; width: auto;">
              ‚è≥ Pendiente
            </button>
            
          </div>
        </div>
        <div><label for="v_fechaHoraAbono">Fecha/Hora de la transferencia</label><div class="field"><input id="v_fechaHoraAbono" class="pill" type="datetime-local"></div></div>
      </div>
    </div>

    <div class="section-card" style="border-color: var(--accent); box-shadow: 0 10px 40px rgba(60,181,121,0.15);">
      <div class="grid-2" style="align-items:end">
        <div>
          <label for="v_referencia">Referencia de Venta / Anuncio</label>
          <div class="field">
            <input id="v_referencia" list="lista_referencias" class="pill" type="text" placeholder="Selecciona o escribe...">
            
            <datalist id="lista_referencias">
              <option value="Recompra">
              <option value="Facebook">
              <option value="Instagram">
              <option value="WhatsApp">
              <option value="Referido">
            </datalist>
          </div>
        </div>
        
        <button id="btnRegistrar" class="cta" style="height: 52px; font-size: 1.1rem; margin-top:0;">REGISTRAR VENTA</button>
      </div>
      
      <input id="v_contrasena" type="hidden">
      <div id="feedbackVenta" class="hint"></div>
    </div>

  </div>

  <div id="toastCenter" class="toast-center" aria-live="assertive">
    <div class="toast-card" id="toastCard" role="alert">
      <div style="display:flex; align-items:center; gap:8px">
        <span id="toastIcon">‚úÖ</span><span id="toastMsg">Listo</span>
      </div>
      <div id="toastDetails" style="font-size:0.9rem; font-weight:400; margin-top:4px; display:none"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    const $$  = sel => document.querySelector(sel);
    const $all = sel => Array.from(document.querySelectorAll(sel));
    const pad2 = n => String(n).padStart(2,'0');
    const normAlnum = s => String(s||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
    const OCR_PLACEHOLDER = 'pega aqu√≠ tu screenshot';
    // VERIFICACI√ìN DE ASIGNADO
    const isAssigned = s => String(s||'').trim().toLowerCase().startsWith('asignado');
    function formatoCOP(n){ return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(Number(n)||0); }

    // ===== MODAL FUNCIONES (NUEVO) =====
    const modal = $$('#modalResult');
    const mIcon = $$('#mIcon');
    const mTitle = $$('#mTitle');
    const mMsg = $$('#mMsg');
    const mBtn = $$('#mBtn');
    
    if(mBtn){
        mBtn.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        });
    }

    function showModal(title, msg, type='ok'){
        if(!modal) return;
        modal.style.display = 'flex';
        // Forzar reflow para la animaci√≥n
        void modal.offsetWidth;
        modal.classList.add('show');
        
        mTitle.textContent = title;
        mMsg.textContent = msg;
        
        if(type === 'error'){
            mIcon.textContent = '‚ö†Ô∏è';
            mTitle.style.color = '#c0392b';
            mBtn.style.background = 'linear-gradient(135deg, #ff7675, #d63031)';
        } else {
            mIcon.textContent = 'üéâ';
            mTitle.style.color = 'var(--ink)';
            mBtn.style.background = 'linear-gradient(180deg, var(--accent), var(--accent-2))';
        }
    }

    // ===== SISTEMA DE LOGIN (LocalStorage) =====
    const STORAGE_KEY = 'asesor_pwd';
    const STORAGE_NAME = 'asesor_name';

    function initLogin(){
      const savedPwd = localStorage.getItem(STORAGE_KEY);
      if(savedPwd){ verificarCredenciales(savedPwd, true); } 
      else { mostrarLogin(); }
    }
    function mostrarLogin(){
      $$('#loginOverlay').style.display = 'flex';
      $$('#appShell').style.display = 'none';
      $$('#topBarShell').style.display = 'none';
      $$('#loginPwd').value = ''; $$('#loginPwd').focus();
    }
    function ocultarLogin(nombre){
      $$('#loginOverlay').style.display = 'none';
      $$('#appShell').style.display = 'block';
      $$('#topBarShell').style.display = 'flex';
      $$('#asesorDisplay').textContent = 'Hola, ' + (nombre || 'Asesor');
      $$('#v_contrasena').value = localStorage.getItem(STORAGE_KEY); // Llenamos el input oculto
    }
    function verificarCredenciales(pwd, auto=false){
      if(!pwd && !auto) { setHint('#loginMsg', 'Escribe tu contrase√±a', true); return; }
      if(!auto) { $$('#btnLogin').textContent = 'Verificando...'; $$('#btnLogin').disabled = true; }

      google.script.run
        .withSuccessHandler(res => {
          if(!auto) { $$('#btnLogin').textContent = 'Ingresar'; $$('#btnLogin').disabled = false; }
          if(res.valido){
            localStorage.setItem(STORAGE_KEY, pwd);
            localStorage.setItem(STORAGE_NAME, res.nombre);
            ocultarLogin(res.nombre);
          } else {
            if(auto) { mostrarLogin(); } else { setHint('#loginMsg', 'Contrase√±a incorrecta', true); }
          }
        })
        .withFailureHandler(err => {
          if(!auto) { $$('#btnLogin').textContent = 'Ingresar'; $$('#btnLogin').disabled = false; setHint('#loginMsg', 'Error de conexi√≥n', true); }
        })
        .verificarCredencialesAsesor(pwd);
    }
    $$('#btnLogin').addEventListener('click', () => verificarCredenciales($$('#loginPwd').value));
    $$('#loginPwd').addEventListener('keydown', (e) => { if(e.key === 'Enter') $$('#btnLogin').click(); });
    $$('#btnLogout').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(STORAGE_NAME); location.reload();
    });
    // ===========================

    function showCenterToast(msg, type='ok', details=''){
      const overlay=$$('#toastCenter'); const card=$$('#toastCard');
      const detEl = $$('#toastDetails');
      $$('#toastIcon').textContent = type==='error' ? '‚ö†Ô∏è' : '‚úÖ';
      card.classList.toggle('error', type==='error');
      $$('#toastMsg').textContent = msg;
      if(details){ detEl.textContent = details; detEl.style.display = 'block'; } 
      else { detEl.style.display = 'none'; }
      overlay.classList.add('show');
      clearTimeout(window.__toastTimer);
      const duration = (type==='error' || details) ? 4500 : 2200;
      window.__toastTimer = setTimeout(()=>overlay.classList.remove('show'), duration);
      try{ navigator.vibrate?.(50) }catch(e){}
    }

    function setHint(elOrSel, msg, isErr=false){
      const el = typeof elOrSel==='string' ? $$(elOrSel) : elOrSel;
      if(!el) return; el.textContent = msg || ''; el.classList.toggle('err', !!isErr);
    }
    function gasPositional(fnName, argsArr, {timeoutMs=15000, onSuccess, onError, onTimeout}={}){
      let done=false;
      const t=setTimeout(()=>{ if(done) return; done=true; onTimeout && onTimeout(); }, timeoutMs);
      try{
        let call = google.script.run;
        call = call.withSuccessHandler(res=>{ if(done) return; done=true; clearTimeout(t); onSuccess && onSuccess(res); });
        call = call.withFailureHandler(err=>{ if(done) return; done=true; clearTimeout(t); onError && onError(err); });
        call[fnName].apply(null, argsArr||[]);
      }catch(e){ if(done) return; done=true; clearTimeout(t); onError && onError(e); }
    }

    // ===== N√∫meros (p√≠ldoras) =====
    const numList = $$('#numList');
    const btnAddNum = $$('#btnAddNum');
    function makeNumPill(value=''){
      const wrap = document.createElement('div'); wrap.className='num-pill';
      const inp  = document.createElement('input'); inp.type='text'; inp.maxLength=4; inp.placeholder='0000';
      inp.value = String(value).replace(/\D+/g,'').slice(-4);
      inp.addEventListener('input',()=>{ inp.value = inp.value.replace(/\D+/g,'').slice(-4); });
      const del  = document.createElement('button'); del.type='button'; del.className='chip-del'; del.textContent='‚úï';
      del.addEventListener('click',()=>{ wrap.remove(); if(numList.children.length===0) addDefaultPill(); });
      wrap.appendChild(inp); wrap.appendChild(del);
      return wrap;
    }
    function addDefaultPill(){ numList.appendChild(makeNumPill()); }
    btnAddNum.addEventListener('click',()=> numList.appendChild(makeNumPill()));
    addDefaultPill();

    // ===== Estado de transferencia seleccionada =====
    let lastTransferSel = null; 

    // Variable global para controlar el estado pendiente
    let esVentaPendiente = false; 

    // L√≥gica del Bot√≥n "Forzar Pendiente"
    // (Aseg√∫rate de pegar esto dentro del script, puede ser antes de initLogin())
    const btnPendiente = document.getElementById('btnForzarPendiente');
    
    if(btnPendiente){
        btnPendiente.addEventListener('click', () => {
            const ref = $$('#v_referenciaAbono').value.trim();
            if(ref.length < 4) { showCenterToast('Escribe la referencia primero', 'error'); return; }
            
            // Simulamos una transferencia seleccionada para que el sistema crea que ya elegimos algo
            lastTransferSel = { referencia: ref, monto: 0, status: 'PENDIENTE' };
            esVentaPendiente = true; 
            
            // Mostramos confirmaci√≥n visual en la lista
            const lista = $$('#listaTransfer');
            lista.style.display = 'block';
            lista.innerHTML = `
                <div class="card-sm" style="background:#fffbf0; border-left:4px solid #e67e22; padding:15px; text-align:center;">
                    <div style="font-weight:700; color:#d35400;">MODO PENDIENTE ACTIVADO</div>
                    <div style="font-size:0.9rem; margin-top:5px;">Referencia: <b>${ref}</b></div>
                    <div style="font-size:0.8rem; color:#666;">Se registrar√° sujeto a verificaci√≥n.</div>
                </div>
            `;
            
            // Mostramos el bot√≥n de cancelar/cambiar
            const btnCambiar = $$('#btnCambiarTransfer');
            btnCambiar.style.display = 'block';
            btnCambiar.textContent = 'Cancelar modo Pendiente';
            btnCambiar.style.background = '#e67e22';
            
            showCenterToast('Modo Pendiente Activado');
        });
    }

    // Ajuste al bot√≥n de cambiar para apagar el modo pendiente
    $$('#btnCambiarTransfer').addEventListener('click', () => {
        esVentaPendiente = false; // Apagamos la bandera
        // ... aqu√≠ sigue tu l√≥gica original de limpiar campos ...
        // Si tu l√≥gica original ya limpia lastTransferSel y el HTML, no necesitas m√°s.
    });

    // ===== OCR =====
    const ocrDrop = $$('#ocrDrop');
    const ocrStatus = $$('#ocrStatus');
    function resetOCRBox(){
      if (ocrStatus) ocrStatus.textContent = OCR_PLACEHOLDER;
      lastTransferSel = null;
    }
    async function preprocessBlobToCanvas(blob){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
          const w = img.naturalWidth || img.width, h = img.naturalHeight || img.height;
          const scale = Math.min(1.5, 1200 / Math.max(w,h));
          const W = Math.round(w*scale), H = Math.round(h*scale);
          const cv = document.createElement('canvas'); cv.width = W; cv.height = H;
          const ctx = cv.getContext('2d');
          ctx.drawImage(img, 0, 0, W, H);
          const imgData = ctx.getImageData(0,0,W,H);
          const d = imgData.data;
          for(let i=0;i<d.length;i+=4){
            const r=d[i], g=d[i+1], b=d[i+2];
            let y = 0.299*r + 0.587*g + 0.114*b;
            y = Math.min(255, Math.max(0, (y-128)*1.2 + 128));
            const v = y > 160 ? 255 : 0;
            d[i]=d[i+1]=d[i+2]=v;
          }
          ctx.putImageData(imgData,0,0);
          resolve(cv);
        };
        img.onerror = ()=> resolve(null);
        img.src = URL.createObjectURL(blob);
      });
    }
    function extractRefFromText(txt){
      const T = (txt||'').toUpperCase().replace(/[^\w]/g,' ');
      const matches = txt.toUpperCase().match(/[A-Z0-9]{6,24}/g) || [];
      if (matches.length === 0) return '';
      const repararCandidato = (str) => {
        if (!str || str.length < 6) return str;
        let primero = str.charAt(0);
        const mapaInicio = { '5':'S', '8':'B', '6':'G', '0':'M' }; 
        if (mapaInicio[primero]) primero = mapaInicio[primero];
        let resto = str.slice(1);
        resto = resto.replace(/O/g, '0').replace(/D/g, '0').replace(/Q/g, '0').replace(/S/g, '5').replace(/B/g, '8').replace(/Z/g, '2').replace(/I/g, '1').replace(/L/g, '1');
        return primero + resto;
      };
      const candidatosCorregidos = matches.map(cand => {
        const corregido = repararCandidato(cand);
        let score = 0;
        if (/^[A-Z][0-9]+$/.test(corregido)) score += 1000;
        score += corregido.length;
        return { texto: corregido, score: score };
      });
      candidatosCorregidos.sort((a,b) => b.score - a.score);
      return candidatosCorregidos[0].texto;
    }
    async function runOCROnBlob(blob){
      try{
        ocrStatus.textContent = 'Leyendo referencia‚Ä¶';
        const pre = await preprocessBlobToCanvas(blob);
        const result = await Tesseract.recognize(pre || blob, 'spa+eng', { tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789' });
        const ref = extractRefFromText(result?.data?.text || '');
        if (!ref){ ocrStatus.textContent='No se detect√≥ referencia.'; showCenterToast('No se detect√≥ referencia','error'); return; }
        ocrStatus.textContent = ref; 
        $$('#v_referenciaAbono').value = ref;
        btnBuscarRef.click(); 
      }catch(e){ ocrStatus.textContent = 'Error de OCR.'; showCenterToast('Error de OCR','error'); }
    }
    function handleFiles(files){
      if(!files || !files.length) return;
      const f = files[0];
      if(!/^image\//.test(f.type)){ ocrStatus.textContent='Formato no soportado.'; showCenterToast('Formato no soportado','error'); return; }
      runOCROnBlob(f);
    }
    if (ocrDrop){
      ocrDrop.addEventListener('paste', (e)=>{
        const items = e.clipboardData?.items || [];
        for(const it of items){ if(it.type?.startsWith('image/')){ handleFiles([it.getAsFile()]); e.preventDefault(); return; } }
      });
      ['dragenter','dragover'].forEach(ev=> ocrDrop.addEventListener(ev, e=>{e.preventDefault(); ocrDrop.classList.add('drag');}));
      ['dragleave','drop'].forEach(ev=> ocrDrop.addEventListener(ev, e=>{e.preventDefault(); ocrDrop.classList.remove('drag');}));
      ocrDrop.addEventListener('drop', e=>{ const files = e.dataTransfer?.files; handleFiles(files); });
    }
    const refField = $$('#v_referenciaAbono');
    refField.addEventListener('input', (e)=>{
      lastTransferSel = null;
      if(!e.target.value.trim()) resetOCRBox();
      $$('#btnCambiarTransfer').style.display = 'none';
    });

    // ===== Hora 12h UI =====
    const ampmBtn = $$('#t_ampm');
    ampmBtn.addEventListener('click', ()=>{ ampmBtn.textContent = ampmBtn.textContent === 'AM' ? 'PM' : 'AM'; });
    function sanitizeTime(){
      let hh = parseInt($$('#t_hh').value,10), mm = parseInt($$('#t_mm').value,10);
      if (isNaN(hh) || hh<1) hh=1; if (hh>12) hh=12;
      if (isNaN(mm) || mm<0) mm=0; if (mm>59) mm=59;
      $$('#t_hh').value = pad2(hh); $$('#t_mm').value = pad2(mm);
      return `${pad2(hh)}:${pad2(mm)} ${ampmBtn.textContent}`;
    }

    // ===== NUEVA L√ìGICA DE B√öSQUEDA =====
    const btnBuscarFecha = $$('#btnBuscarFecha');
    const btnBuscarRef = $$('#btnBuscarRef');
    const btnCambiarTransfer = $$('#btnCambiarTransfer');
    const elHintTransfer = $$('#feedbackTransfer');
    const listaTransfer = $$('#listaTransfer'); 

    const normRefKey = s => String(s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').trim();
    function uniqueTransfersByRef(list){
      const map=new Map();
      for(const raw of (list||[])){
        const t={...raw, sheet:String(raw.sheet||'').trim(), row:parseInt(raw.row,10),
                 referencia:String(raw.referencia||'').trim(), plataforma:String(raw.plataforma||'').trim()};
        const key=normRefKey(t.referencia); const prev=map.get(key);
        if(!prev || (!isAssigned(t.status) && isAssigned(prev.status))) map.set(key,t);
      }
      return [...map.values()];
    }

    function pintarListaResultados(lista, origen){
        // Si no hay resultados, limpiar y salir
        if(!lista.length) { listaTransfer.innerHTML='<div class="hint">Sin resultados</div>'; return; }
        
        // Grid para acomodar tarjetas
        listaTransfer.style.display = 'grid';
        listaTransfer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(280px, 1fr))'; 
        listaTransfer.style.gap = '12px';
        
        listaTransfer.innerHTML = lista.map((t,idx)=> {
            const ocupado = isAssigned(t.status);
            // Colores din√°micos
            const bordeColor = ocupado ? '#ccc' : '#3cb579';
            const bgColor    = ocupado ? '#f9fafb' : '#fff';
            const opacity    = ocupado ? '0.8' : '1';
            
            // --- L√ìGICA DE LOGOS (URLs ESTABLES DE GITHUB) ---
            let logoHtml = '';
            const plat = (t.plataforma || '').toLowerCase();
            
            // Usamos im√°genes "raw" de GitHub que no tienen bloqueo
            if(plat.includes('bancolombia')) {
                // Logo Bancolombia
                logoHtml = `<img src="https://losplata.s3.us-east-2.amazonaws.com/Dise%C3%B1o+sin+t%C3%ADtulo+(5).png" style="height: 100%; max-width: 100%; object-fit: contain;" alt="Bancolombia" onerror="this.style.display='none'; this.parentNode.innerText='BANCOLOMBIA'">`;
            } else if(plat.includes('nequi')) {
                // Logo Nequi
                logoHtml = `<img src="https://losplata.s3.us-east-2.amazonaws.com/Dise%C3%B1o+sin+t%C3%ADtulo+(2).png" style="height: 100%; max-width: 100%; object-fit: contain;" alt="Nequi" onerror="this.style.display='none'; this.parentNode.innerText='NEQUI'">`;
            } else if(plat.includes('daviplata')) {
                // Logo Daviplata
                logoHtml = `<img src="https://losplata.s3.us-east-2.amazonaws.com/Dise%C3%B1o+sin+t%C3%ADtulo+(4).png" style="height: 100%; max-width: 100%; object-fit: contain;" alt="Daviplata" onerror="this.style.display='none'; this.parentNode.innerText='DAVIPLATA'">`;
            } else {
                // Fallback texto
                const badgeColor = ocupado ? '#6b7280' : '#ffffff'; 
                logoHtml = `<span style="color:${badgeColor}; font-size:0.8rem; font-weight:800; text-transform:uppercase;">${t.plataforma || 'BANCO'}</span>`;
            }
            
            // Fondo del contenedor del logo (Blanco para im√°genes)
            const logoContainerBg = (logoHtml.includes('<img')) ? '#ffffff' : (ocupado ? '#e5e7eb' : '#3cb579');
            const logoBorder = (logoHtml.includes('<img')) ? '1px solid #eee' : 'none';

            return `
            <div class="card-sm" style="
                border-left: 4px solid ${bordeColor}; 
                background: ${bgColor}; 
                opacity: ${opacity}; 
                padding: 10px 14px; 
                margin: 0; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                border-radius: 12px;
                display: flex; flex-direction: column; justify-content: space-between;
            ">
              
              <div style="display: grid; grid-template-columns: 1fr 120px; gap: 12px; align-items: center; margin-bottom: 8px;">
                 
                 <div style="text-align: left;">
                    <div style="font-size:0.7rem; color:#7ea094; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">Monto</div>
                    <div style="font-size:1.4rem; font-weight:800; color:#244a3e; line-height:1;">${formatoCOP(t.monto||0)}</div>
                 </div>

                 <div style="
                    background:${logoContainerBg}; 
                    border: ${logoBorder};
                    border-radius: 8px; 
                    display: flex; align-items: center; justify-content: center;
                    height: 40px; /* Altura fija para que todos se vean iguales */
                    width: 100%;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    overflow: hidden;
                    padding: 4px;
                 ">
                    ${logoHtml}
                 </div>
              </div>

              <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.8rem; color:#5a7a70; border-top:1px dashed #e5e7eb; padding-top:8px; margin-bottom:10px;">
                 <div>
                   <span style="opacity:0.6;">Ref:</span> <span style="font-weight:700; color:#2d5b4f">${t.referencia||'‚Äî'}</span>
                 </div>
                 <div style="text-align:right;">
                   <span style="font-weight:700">${t.hora||'--'}</span> <span style="opacity:0.7; font-size:0.75rem">(${t.fecha||''})</span>
                 </div>
              </div>

              ${ocupado
                ? `<button class="cta" disabled style="background:#d1d5db; color:#6b7280; width:100%; padding:8px; margin:0; box-shadow:none; border-radius:8px; font-size:0.9rem;">‚õî Asignada</button>`
                : `<button class="cta" data-i="${idx}" style="width:100%; margin:0; padding:8px; border-radius:8px; font-size:0.9rem;">‚úÖ Usar esta</button>`}
            </div>`;
        }).join('');
        
        // Event Listeners
        listaTransfer.querySelectorAll('button[data-i]').forEach(b=>{
            b.addEventListener('click', ()=>{
                const t = lista[parseInt(b.dataset.i,10)];
                if(isAssigned(t.status)) { showCenterToast('Ocupada','error'); return; }
                
                listaTransfer.innerHTML = ''; 
                listaTransfer.style.display = 'block';
                
                lastTransferSel = t;
                ocrStatus.textContent = t.referencia || OCR_PLACEHOLDER;
                
                // Detectar funci√≥n seg√∫n archivo (Venta o Abono)
                if(typeof autocompletarVentaDesdeTransferencia === 'function') autocompletarVentaDesdeTransferencia(t);
                if(typeof aplicarTransferencia === 'function') aplicarTransferencia(t);

                if(typeof btnCambiarTransfer !== 'undefined') btnCambiarTransfer.style.display='block';
                setHint(elHintTransfer, `Transferencia seleccionada ‚úì`);
                showCenterToast('Transferencia aplicada ‚úì');
            });
        });
    }

    btnBuscarFecha.addEventListener('click', ()=>{
      $$('#v_referenciaAbono').value = ''; resetOCRBox(); setHint(elHintTransfer, ''); listaTransfer.innerHTML = '';
      const fechaISO = $$('#t_fecha').value;
      if(!fechaISO){ setHint(elHintTransfer, 'Selecciona fecha primero.', true); return; }
      const hora12 = sanitizeTime();
      const oldText = btnBuscarFecha.textContent;
      btnBuscarFecha.textContent = 'Buscando‚Ä¶'; btnBuscarFecha.disabled = true; btnBuscarRef.disabled = true;

      google.script.run
        .withSuccessHandler(res=>{
          btnBuscarFecha.textContent = oldText; btnBuscarFecha.disabled = false; btnBuscarRef.disabled = false;
          if(!res || !res.status){ setHint(elHintTransfer, 'Respuesta inesperada.', true); showCenterToast('Error', 'error'); return; }
          let lista = uniqueTransfersByRef(Array.isArray(res.lista)? res.lista : []);
          if(lista.length === 0){ setHint(elHintTransfer, 'No hay transferencias en esa hora (¬±5 min).'); return; }
          setHint(elHintTransfer, `Se encontraron ${lista.length} transferencia(s). Selecciona una:`);
          pintarListaResultados(lista, 'hora');
        })
        .withFailureHandler(()=>{
          btnBuscarFecha.textContent = oldText; btnBuscarFecha.disabled = false; btnBuscarRef.disabled = false;
          setHint(elHintTransfer, 'Error consultando por fecha.', true); showCenterToast('Error de conexi√≥n', 'error');
        })
        .buscarTransferenciasExactas({fechaISO, hora12});
    });

    btnBuscarRef.addEventListener('click', ()=>{
      const refManual = $$('#v_referenciaAbono').value.trim();
      if (refManual.length < 4){ setHint(elHintTransfer, 'Escribe o pega una referencia v√°lida (m√≠nimo 4 caracteres).', true); return; }
      setHint(elHintTransfer, ''); listaTransfer.innerHTML = '';
      const oldText = btnBuscarRef.textContent;
      btnBuscarRef.textContent = 'Buscando‚Ä¶'; btnBuscarRef.disabled = true; btnBuscarFecha.disabled = true;

      gasPositional('buscarTransferenciaPorReferenciaExacta', [refManual], {
        onSuccess:(res)=>{
          btnBuscarRef.textContent = oldText; btnBuscarRef.disabled = false; btnBuscarFecha.disabled = false;
          if(!res || !res.status){ setHint(elHintTransfer,'Respuesta inesperada.', true); showCenterToast('Error','error'); return; }
          const list = res.lista || [];
          if(list.length===0){ setHint(elHintTransfer, 'No hay coincidencias exactas.'); return; }
          const free = list.find(t => !isAssigned(t.status));
          if(!free){
            lastTransferSel = null;
            btnCambiarTransfer.style.display='none';
            ocrStatus.textContent = (list[0].referencia || refManual) + ' (Asignada)';
            setHint(elHintTransfer, 'Referencia encontrada pero ya est√° Asignada.', true);
            showCenterToast('Transferencia ya Asignada', 'error');
            return;
          }
          const t = free;
          lastTransferSel = t;
          ocrStatus.textContent = t.referencia || refManual;
          autocompletarVentaDesdeTransferencia(t);
          btnCambiarTransfer.style.display='block';
          setHint(elHintTransfer, `Transferencia encontrada ‚úì`);
          showCenterToast('Transferencia aplicada ‚úì');
        },
        onError:()=>{
          btnBuscarRef.textContent = oldText; btnBuscarRef.disabled = false; btnBuscarFecha.disabled = false;
          setHint(elHintTransfer,'Error de conexi√≥n.', true); showCenterToast('Error de conexi√≥n','error');
        },
        onTimeout:()=>{
          btnBuscarRef.textContent = oldText; btnBuscarRef.disabled = false; btnBuscarFecha.disabled = false;
          setHint(elHintTransfer,'Sin respuesta.', true); showCenterToast('Sin respuesta','error');
        }
      });
    });

    function autocompletarVentaDesdeTransferencia(t){
      if (t.monto != null) { const el = $$('#v_primerAbono'); if(el) el.value = String(t.monto); }
      if (t.referencia)   { const el = $$('#v_referenciaAbono'); if(el) el.value = t.referencia; }
      if (t.plataforma)   {
        const sel = $$('#v_metodoPago');
        if (sel){
          const match = Array.from(sel.options).find(o => (o.value||o.text).toLowerCase().trim() === String(t.plataforma).toLowerCase().trim());
          sel.value = match ? match.value : '';
        }
      }
      if (t.fecha && t.hora){
        const iso = toDatetimeLocalFromDisp(t.fecha, t.hora);
        const el = $$('#v_fechaHoraAbono');
        if (iso && el) el.value = iso;
      }
    }
    function toDatetimeLocalFromDisp(fechaDisp, hora12){
      function parseFecha(s){
        s = String(s||'').trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        const m = s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
        if(!m) return '';
        const d = ('0'+m[1]).slice(-2), mo=('0'+m[2]).slice(-2), y = m[3].length===2 ? ('20'+m[3]) : m[3];
        return `${y}-${mo}-${d}`;
      }
      function to24(h12){
        const m = String(h12||'').match(/(\d{1,2})\s*:\s*(\d{2})\s*(am|pm)?/i);
        if(!m) return '00:00';
        let hh = parseInt(m[1],10), mm = ('0'+parseInt(m[2],10)).slice(-2);
        const ap = (m[3]||'').toLowerCase();
        if(ap==='pm' && hh<12) hh+=12;
        if(ap==='am' && hh===12) hh=0;
        return ('0'+hh).slice(-2) + ':' + mm;
      }
      const d = parseFecha(fechaDisp);
      const h = to24(hora12);
      if(!d) return '';
      return `${d}T${h}`;
    }

    const btnRegistrar = $$('#btnRegistrar');
    const elVentaHint  = $$('#feedbackVenta');

    function getNums(){
      return $all('#numList .num-pill input')
        .map(i => i.value.replace(/\D+/g,'').slice(0,4))
        .filter(v => v.length===4);
    }

    // === L√ìGICA INTELIGENTE: SEPARADOS ($0) Y REFERENCIAS AUTO ===
    btnRegistrar.addEventListener('click', ()=>{
      const numeros = getNums();
      if(numeros.length===0){ setHint(elVentaHint, 'Agrega al menos un n√∫mero v√°lido (4 d√≠gitos).', true); return; }

      // 1. OBTENER EL VALOR A ABONAR
      const totalMoney = Number($$('#v_primerAbono').value) || 0;
      const esSeparado = (totalMoney === 0);

      // 2. VALIDAR CAMPOS OBLIGATORIOS (Datos Personales)
      // Nota: Ya no incluimos 'v_referencia' ni 'v_referenciaAbono' aqu√≠
      // Agregamos 'v_ns_usuario' a la lista de requeridos
      const req = ['v_nombre','v_apellido','v_ciudad','v_telefono', 'v_ns_usuario'];
      for(const id of req){ 
         const el=$$('#'+id); 
         if(!el.checkValidity()){ el.reportValidity(); return; } 
      }

      // 3. VALIDAR PAGO (Solo si el abono es mayor a 0)
      const inputMetodo = $$('#v_metodoPago');
      const inputRefAbono = $$('#v_referenciaAbono');

      if (!esSeparado) {
         // Si hay dinero, exigimos M√©todo y Referencia de pago
         if (!inputMetodo.checkValidity() || inputMetodo.value === "") {
             inputMetodo.reportValidity(); return;
         }
         if (!inputRefAbono.value.trim()) {
             showCenterToast('Falta la referencia del pago', 'error');
             inputRefAbono.focus(); return;
         }
      }

      // IMPORTANTE: Validar la contrase√±a
      const pwd = $$('#v_contrasena').value.trim();
      if(!pwd){ showCenterToast('Sesi√≥n expirada. Recarga.', 'error'); return; }

      // Validar si la transferencia ya estaba usada (Solo si no es separado)
      if (!esSeparado && lastTransferSel && isAssigned(lastTransferSel.status)){
        setHint(elVentaHint, 'Transferencia Asignada: no se puede reutilizar.', true);
        showCenterToast('Transferencia Asignada', 'error');
        return;
      }

      // --- DEFINICI√ìN AUTOM√ÅTICA DE VALORES ---
      // Si es separado ($0), forzamos "Separado" y Ref "0". Si no, usamos lo que escribi√≥ el usuario.
      const metodoFinal = esSeparado ? "Separado" : inputMetodo.value;
      const refAbonoFinal = esSeparado ? "0" : inputRefAbono.value.trim();
      
      // Referencia de Venta (Anuncio): Si est√° vac√≠a, ponemos "0"
      let refVentaFinal = $$('#v_referencia').value.trim();
      if (refVentaFinal === "") refVentaFinal = "0";


      // --- C√ÅLCULO DE DIVISI√ìN ---
      const count = numeros.length;
      const individualMoney = count > 0 ? Math.floor(totalMoney / count) : 0;

      const baseDatos = {
        nombre: $$('#v_nombre').value.trim(),
        apellido: $$('#v_apellido').value.trim(),
        ciudad: $$('#v_ciudad').value.trim(),
        telefono: $$('#v_telefono').value.trim(),
        nsUsuario: $$('#v_ns_usuario').value.trim(),
        primerAbono: individualMoney,
        referenciaAbono: refAbonoFinal,      // Usamos el valor calculado
        fechaHoraAbono: $$('#v_fechaHoraAbono').value,
        metodoPago: metodoFinal,             // Usamos el valor calculado
        referencia: refVentaFinal,           // Usamos el valor calculado (o "0")
        contrasena: pwd,
        esPendiente: esVentaPendiente
      };

      let idx=0, ok=0, fails=0;
      let errorDetails = [];
      const total = numeros.length;
      const old = btnRegistrar.textContent; btnRegistrar.disabled=true;
      
      const loop = ()=>{
        if(idx>=total){
          btnRegistrar.textContent = old;
          btnRegistrar.disabled=false;
          
          const msg = `Proceso finalizado: ${ok}/${total} registradas.`;
          let finalHint = msg;
          
          if(fails > 0 && errorDetails.length > 0) {
             finalHint += "\n\n" + errorDetails.join("\n");
             showModal('¬°Atenci√≥n!', finalHint, 'error');
          } else {
             showModal('¬°Venta Exitosa!', msg, 'ok');
          }

          if (ok>0 && lastTransferSel && lastTransferSel.row && !isAssigned(lastTransferSel.status)){
            google.script.run
              .withSuccessHandler(()=> showCenterToast('Transferencia marcada como Asignada ‚úì'))
              .withFailureHandler(()=> showCenterToast('No se pudo marcar como Asignada','error'))
              .asignarTransferenciaPorFila({sheet:lastTransferSel.sheet, row:lastTransferSel.row});
          }

          resetOCRBox();
          if (fails===0){
            numList.innerHTML=''; addDefaultPill();
            
            // AGREGADO: 'v_ns_usuario' a la lista para que se borre tambi√©n
            ['v_nombre','v_apellido','v_ciudad','v_telefono','v_referencia','v_referenciaAbono', 'v_ns_usuario'].forEach(id=> $$('#'+id).value='');
            
            $$('#v_primerAbono').value = 0;
            $$('#v_metodoPago').value = '';
            initDefaults();
          }
          return;
        }
        
        const n = numeros[idx++];
        btnRegistrar.textContent = `Registrando ${idx}/${total}‚Ä¶`;
        const payload = Object.assign({}, baseDatos, { numeroBoleta:n });
        
        google.script.run
          .withSuccessHandler(res=>{ 
            if(res && res.status==='ok'){ ok++; } 
            else { 
              fails++;
              const motivo = res.mensaje || 'Error desconocido';
              errorDetails.push(`Boleta ${n}: ${motivo}`);
            } 
            loop(); 
          })
          .withFailureHandler(err=>{ fails++; errorDetails.push(`Boleta ${n}: Error de conexi√≥n.`); loop(); })
          .validarVentaYRegistrar(payload);
      };

      setHint(elVentaHint, 'Iniciando registro‚Ä¶');
      loop();
    });

    function initDefaults(){
      const now = new Date();
      const tzOff = now.getTimezoneOffset()*60000;
      $$('#v_fechaHoraAbono').value = new Date(now - tzOff).toISOString().slice(0,16);
      $$('#t_fecha').value ¬† ¬† ¬† ¬† ¬†= new Date(now - tzOff).toISOString().slice(0,10);
      let H = now.getHours(), M = now.getMinutes();
      const ampm = (H>=12) ? 'PM' : 'AM';
      if(H===0) H=12; else if(H>12) H-=12;
      $$('#t_hh').value = pad2(H); $$('#t_mm').value = pad2(M); $$('#t_ampm').textContent = ampm;
      resetOCRBox();
      $$('#btnCambiarTransfer').style.display='none';
      if(listaTransfer) listaTransfer.innerHTML = '';
    }

    // ===== L√ìGICA DE PEGADO M√ÅGICO (AUTORRELLENO) =====
    const magicInput = document.getElementById('magicPaste');

    if(magicInput){
      magicInput.addEventListener('input', (e) => {
        const text = e.target.value;
        if(!text.trim()) return;

        // 1. Dividir texto por l√≠neas y limpiar espacios vac√≠os
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");

        // 2. Asignar datos seg√∫n el orden exacto que indicaste:
        
        // L√≠nea 1: Nombre
        if(lines.length > 0) $$('#v_nombre').value = lines[0];
        
        // L√≠nea 2: Apellido
        if(lines.length > 1) $$('#v_apellido').value = lines[1];
        
        // L√≠nea 3: Ciudad
        if(lines.length > 2) $$('#v_ciudad').value = lines[2];
        
        // L√≠nea 4: Boletas (Soporta varias separadas por coma)
        if(lines.length > 3) {
           const rawBoletas = lines[3];
           $$('#numList').innerHTML = ''; // Limpiar lista actual
           
           // Extraer n√∫meros y limpiar basura
           const nums = rawBoletas.split(',').map(b => b.replace(/\D+/g,'')).filter(b => b.length > 0);
           
           nums.forEach(n => {
             const pill = makeNumPill(n); // Crea la "p√≠ldora" visual
             $$('#numList').appendChild(pill);
           });
           
           // Si la l√≠nea estaba vac√≠a o sin n√∫meros v√°lidos, ponemos una casilla vac√≠a
           if(nums.length === 0) addDefaultPill();
        }

        // L√≠nea 5: Tel√©fono
        if(lines.length > 4) $$('#v_telefono').value = lines[4];
        
        // L√≠nea 6: NS Usuario (El dato nuevo)
        if(lines.length > 5) $$('#v_ns_usuario').value = lines[5];

        showCenterToast('¬°Datos cargados m√°gicamente! ‚ú®');
        
        // Limpiamos la caja verde autom√°ticamente despu√©s de 1 segundo
        setTimeout(() => { magicInput.value = ''; }, 1000);
      });
    }
    
    initLogin();
    initDefaults();
  </script>
</body>
</html>